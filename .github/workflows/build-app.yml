name: Build Mobile App

on:
  repository_dispatch:
    types: [build_mobile_app]

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  build:
    name: Build Mobile App
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ” Fetch build configuration from API
      id: fetch-config
      run: |
        echo "ğŸ“¡ Fetching configuration for build ID: ${{ github.event.client_payload.build_id }}"
        
        # API í˜¸ì¶œí•˜ì—¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        CONFIG_URL="https://system.withcookie.com/api/app-builder/github/config/${{ github.event.client_payload.build_id }}"
        echo "ğŸ”— API URL: $CONFIG_URL"
        
        # curlë¡œ API í˜¸ì¶œ ë° ì‘ë‹µ ì €ì¥
        HTTP_STATUS=$(curl -s -w "%{http_code}" -o build_config.json "$CONFIG_URL")
        
        if [ "$HTTP_STATUS" -eq 200 ]; then
          echo "âœ… Successfully fetched build configuration"
          cat build_config.json
          
          # JSON íŒŒì‹±í•˜ì—¬ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
          echo "APP_NAME=$(jq -r '.app_name // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "PACKAGE_NAME=$(jq -r '.package_name // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "APP_URL=$(jq -r '.app_url // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$(jq -r '.version_name // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$(jq -r '.version_code // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "PLATFORM=$(jq -r '.platform // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "BUILD_TYPE=$(jq -r '.build_type // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "PRIMARY_COLOR=$(jq -r '.primary_color // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "ICON_URL=$(jq -r '.icon_url // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "FIREBASE_CONFIG_URL=$(jq -r '.firebase_config_url // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "KEYSTORE_URL=$(jq -r '.keystore_url // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "KEYSTORE_PASSWORD=$(jq -r '.keystore_password // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "KEY_ALIAS=$(jq -r '.key_alias // empty' build_config.json)" >> $GITHUB_OUTPUT
          echo "KEY_PASSWORD=$(jq -r '.key_password // empty' build_config.json)" >> $GITHUB_OUTPUT
          
          echo "CONFIG_FETCHED=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Failed to fetch configuration (HTTP $HTTP_STATUS), using client_payload values"
          echo "CONFIG_FETCHED=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ“‹ Display build configuration
      run: |
        echo "ğŸ”§ Build Configuration:"
        echo "  Build ID: ${{ github.event.client_payload.build_id || 'test-build' }}"
        echo "  App Name: ${{ steps.fetch-config.outputs.APP_NAME || github.event.client_payload.app_name || 'TestApp' }}"
        echo "  Package Name: ${{ steps.fetch-config.outputs.PACKAGE_NAME || github.event.client_payload.package_name || 'com.test.app' }}"
        echo "  Platform: ${{ steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android' }}"
        echo "  Build Type: ${{ steps.fetch-config.outputs.BUILD_TYPE || github.event.client_payload.build_type || 'apk' }}"
        echo "  Base URL: ${{ steps.fetch-config.outputs.APP_URL || github.event.client_payload.base_url || github.event.client_payload.app_url || 'https://test.com' }}"
        echo "  Version Name: ${{ steps.fetch-config.outputs.VERSION_NAME || github.event.client_payload.version_name || '1.0.0' }}"
        echo "  Version Code: ${{ steps.fetch-config.outputs.VERSION_CODE || github.event.client_payload.version_code || '1' }}"
        echo "  Primary Color: ${{ steps.fetch-config.outputs.PRIMARY_COLOR || github.event.client_payload.primary_color || '#2F80ED' }}"
        echo "  Event: ${{ github.event_name }}"
        echo "  Config Source: ${{ steps.fetch-config.outputs.CONFIG_FETCHED == 'true' && 'API' || 'client_payload' }}"
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    # Android ì „ìš© ì„¤ì •
    - name: â˜• Setup JDK (Android)
      if: (steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android') == 'android'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: ğŸ¤– Setup Android SDK (Android)
      if: (steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android') == 'android'
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 25.1.8937393
    
    # iOS ì „ìš© ì„¤ì •
    - name: ğŸ Setup Xcode (iOS)
      if: (steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform) == 'ios'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
    
    - name: ğŸ Setup CocoaPods (iOS)
      if: (steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform) == 'ios'
      uses: maxim-lobanov/setup-cocoapods@v1
      with:
        version: latest
    
    # ê³µí†µ ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ Install dependencies
      run: |
        npm install
        # Sharp ì´ë¯¸ì§€ ì²˜ë¦¬ìš© (ì•„ì´ì½˜ ìƒì„±)
        npm install sharp
    
    # ì•± ì„¤ì • êµ¬ì„±
    - name: ğŸ”§ Configure app settings
      env:
        BUILD_ID: ${{ github.event.client_payload.build_id || 'test-build' }}
        APP_NAME: ${{ steps.fetch-config.outputs.APP_NAME || github.event.client_payload.app_name || 'TestApp' }}
        PACKAGE_NAME: ${{ steps.fetch-config.outputs.PACKAGE_NAME || github.event.client_payload.package_name || 'com.test.app' }}
        PLATFORM: ${{ steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android' }}
        BASE_URL: ${{ steps.fetch-config.outputs.APP_URL || github.event.client_payload.base_url || github.event.client_payload.app_url || 'https://withcookie.com' }}
        APP_ICON_URL: ${{ steps.fetch-config.outputs.ICON_URL || github.event.client_payload.icon_url || github.event.client_payload.app_icon_url }}
        FIREBASE_CONFIG_URL: ${{ steps.fetch-config.outputs.FIREBASE_CONFIG_URL || github.event.client_payload.firebase_config_url }}
        KEYSTORE_URL: ${{ steps.fetch-config.outputs.KEYSTORE_URL || github.event.client_payload.keystore_url }}
        KEYSTORE_PASSWORD: ${{ steps.fetch-config.outputs.KEYSTORE_PASSWORD || github.event.client_payload.keystore_password }}
        KEY_ALIAS: ${{ steps.fetch-config.outputs.KEY_ALIAS || github.event.client_payload.key_alias }}
        KEY_PASSWORD: ${{ steps.fetch-config.outputs.KEY_PASSWORD || github.event.client_payload.key_password }}
        BUILD_TYPE: ${{ steps.fetch-config.outputs.BUILD_TYPE || github.event.client_payload.build_type || 'apk' }}
        VERSION_CODE: ${{ steps.fetch-config.outputs.VERSION_CODE || github.event.client_payload.version_code || '1' }}
        VERSION_NAME: ${{ steps.fetch-config.outputs.VERSION_NAME || github.event.client_payload.version_name || '1.0.0' }}
        BUILD_NUMBER: ${{ steps.fetch-config.outputs.VERSION_CODE || github.event.client_payload.build_number || github.event.client_payload.version_code || '1' }}
        MARKETING_VERSION: ${{ steps.fetch-config.outputs.VERSION_NAME || github.event.client_payload.marketing_version || github.event.client_payload.version_name || '1.0.0' }}
        PRIMARY_COLOR: ${{ steps.fetch-config.outputs.PRIMARY_COLOR || github.event.client_payload.primary_color }}
      run: |
        node scripts/configure-app.js
    
    # Android ë¹Œë“œ
    - name: ğŸ¤– Build Android App
      if: (steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android') == 'android'
      env:
        BUILD_TYPE: ${{ steps.fetch-config.outputs.BUILD_TYPE || github.event.client_payload.build_type || 'apk' }}
        BUILD_MODE: release
        APP_NAME: ${{ steps.fetch-config.outputs.APP_NAME || github.event.client_payload.app_name || 'TestApp' }}
        PACKAGE_NAME: ${{ steps.fetch-config.outputs.PACKAGE_NAME || github.event.client_payload.package_name || 'com.test.app' }}
        VERSION_CODE: ${{ steps.fetch-config.outputs.VERSION_CODE || github.event.client_payload.version_code || '1' }}
        VERSION_NAME: ${{ steps.fetch-config.outputs.VERSION_NAME || github.event.client_payload.version_name || '1.0.0' }}
        KEYSTORE_URL: ${{ steps.fetch-config.outputs.KEYSTORE_URL || github.event.client_payload.keystore_url }}
        KEYSTORE_PASSWORD: ${{ steps.fetch-config.outputs.KEYSTORE_PASSWORD || github.event.client_payload.keystore_password }}
      run: |
        chmod +x scripts/build-android.sh
        scripts/build-android.sh
    
    # iOS ë¹Œë“œ
    - name: ğŸ Build iOS App
      if: (steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform) == 'ios'
      env:
        BUILD_MODE: release
        APP_NAME: ${{ steps.fetch-config.outputs.APP_NAME || github.event.client_payload.app_name }}
        PACKAGE_NAME: ${{ steps.fetch-config.outputs.PACKAGE_NAME || github.event.client_payload.package_name }}
        BUILD_NUMBER: ${{ steps.fetch-config.outputs.VERSION_CODE || github.event.client_payload.build_number || github.event.client_payload.version_code || '1' }}
        MARKETING_VERSION: ${{ steps.fetch-config.outputs.VERSION_NAME || github.event.client_payload.marketing_version || github.event.client_payload.version_name || '1.0.0' }}
      run: |
        chmod +x scripts/build-ios.sh
        scripts/build-ios.sh
    
    # ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ ì¤€ë¹„
    - name: ğŸ“¦ Prepare build artifacts
      id: prepare-artifacts
      run: |
        PLATFORM="${{ steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android' }}"
        BUILD_TYPE="${{ steps.fetch-config.outputs.BUILD_TYPE || github.event.client_payload.build_type || 'apk' }}"
        
        if [ "$PLATFORM" = "android" ]; then
          if [ "$BUILD_TYPE" = "aab" ]; then
            BUILD_FILE=$(find android/app/build/outputs/bundle -name "*.aab" | head -1)
          else
            BUILD_FILE=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          fi
        else
          BUILD_FILE=$(find ios/build -name "*.ipa" | head -1)
        fi
        
        if [ -f "$BUILD_FILE" ]; then
          echo "build_file=$BUILD_FILE" >> $GITHUB_OUTPUT
          echo "âœ… Build file found: $BUILD_FILE"
          ls -la "$BUILD_FILE"
        else
          echo "âŒ Build file not found"
          exit 1
        fi
    
    # ë‹¤ìš´ë¡œë“œ URL ìƒì„± ë° ì „ë‹¬
    - name: ğŸ”— Generate download URL
      id: generate-url
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        BUILD_ID: ${{ github.event.client_payload.build_id || 'test-build' }}
        PLATFORM: ${{ steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android' }}
        BUILD_TYPE: ${{ steps.fetch-config.outputs.BUILD_TYPE || github.event.client_payload.build_type || 'apk' }}
        S3_UPLOAD_URL: ${{ github.event.client_payload.s3_upload_url }}
        ARTIFACT_NAME: build-${{ steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android' }}-${{ github.event.client_payload.build_id || 'test-build' }}
      run: |
        echo "ğŸ“¥ Generating download information..."
        node scripts/generate-artifact-url.js
    
    # S3 ì—…ë¡œë“œ ì‹œë„ (ì••ì¶• í›„ ì—…ë¡œë“œ)
    - name: â˜ï¸ Upload to S3 with Compression
      continue-on-error: true
      env:
        BUILD_ID: ${{ github.event.client_payload.build_id }}
        PLATFORM: ${{ steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform }}
        BUILD_TYPE: ${{ steps.fetch-config.outputs.BUILD_TYPE || github.event.client_payload.build_type }}
        S3_UPLOAD_URL: ${{ github.event.client_payload.s3_upload_url }}
        BUILD_FILE: ${{ steps.prepare-artifacts.outputs.build_file }}
        REFRIGERATOR_UNLIMITED_KEY: ${{ secrets.REFRIGERATOR_UNLIMITED_KEY || 'UNLIMITED2024' }}
      run: |
        if [ -f "$BUILD_FILE" ]; then
          # íŒŒì¼ í¬ê¸° í™•ì¸
          FILE_SIZE_MB=$(du -m "$BUILD_FILE" | cut -f1)
          echo "ğŸ“ Original file size: ${FILE_SIZE_MB}MB"
          
          echo "ğŸ—œï¸ Attempting compressed upload to S3..."
          node scripts/upload-compressed.js || {
            echo "âš ï¸ Compressed upload failed, trying regular upload..."
            if [ "$FILE_SIZE_MB" -le 20 ]; then
              echo "âœ… File is small enough for regular Refrigerator upload"
              node scripts/upload-to-s3.js || echo "âš ï¸ Regular upload also failed, but GitHub Artifacts is available"
            else
              echo "âš ï¸ File too large for regular Refrigerator (${FILE_SIZE_MB}MB > 20MB)"
              echo "ğŸ“¥ Please use GitHub Artifacts download instead"
            fi
          }
        else
          echo "âŒ No build file found"
        fi
    
    # ë¹Œë“œ ê²°ê³¼ ì•Œë¦¼
    - name: ğŸ“¬ Notify build completion
      if: always()
      env:
        BUILD_ID: ${{ github.event.client_payload.build_id }}
        PLATFORM: ${{ steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform }}
        BUILD_TYPE: ${{ steps.fetch-config.outputs.BUILD_TYPE || github.event.client_payload.build_type }}
        S3_UPLOAD_URL: ${{ github.event.client_payload.s3_upload_url }}
        BUILD_STATUS: ${{ job.status }}
      run: |
        NOTIFICATION_PAYLOAD=$(cat <<EOF
        {
          "build_id": "$BUILD_ID",
          "platform": "$PLATFORM",
          "build_type": "$BUILD_TYPE",
          "status": "$BUILD_STATUS",
          "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "github_run_id": "${{ github.run_id }}",
          "github_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
          "download_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts",
          "download_method": "GitHub Artifacts",
          "message": "Build completed. Download from GitHub Actions Artifacts section."
        }
        EOF
        )
        
        if [ -n "$S3_UPLOAD_URL" ]; then
          echo "ğŸ“¬ Sending build completion notification..."
          curl -X POST "$S3_UPLOAD_URL" \
            -H "Content-Type: application/json" \
            -d "$NOTIFICATION_PAYLOAD" \
            || echo "âš ï¸ Failed to send notification"
        else
          echo "âš ï¸ No notification URL provided"
        fi
        
        echo "âœ… Build process completed with status: $BUILD_STATUS"
    
    # ì•„í‹°íŒ©íŠ¸ ì €ì¥ (ë””ë²„ê·¸ìš©)
    - name: ğŸ“ Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ steps.fetch-config.outputs.PLATFORM || github.event.client_payload.platform || 'android' }}-${{ github.event.client_payload.build_id || 'test-build' }}
        path: |
          android/app/build/outputs/**/*.apk
          android/app/build/outputs/**/*.aab
          ios/build/*.ipa
        if-no-files-found: ignore
        retention-days: 7